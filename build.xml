<?xml version="1.0"?>
<project name="kuali" default="dist-local" basedir=".">
	<!-- run the help task to view usage instructions -->
	<target name="dist-local" if="is.local.build" depends="clean,filter-project,filter-local,dist-workflow-local" description="Prepare local configuration files and tokenized resources and deploy tomcat context file on development workstation">
		<copy file="${metainf.directory}/${tomcat.context.file}" tofile="${appserver.localhost.dir}/${ant.project.name}-${build.environment}.xml" overwrite="true" />
	</target>

	<target name="test-local" depends="use-test-spring-beans,dist-local,make-tests,test" description="Run all unit tests and format results"/>

	<target name="echo-properties" depends="init-filter-sets" description="Print all build properties that have been set">
		<echoproperties />
	</target>
	
	<target name="clean" depends="clean-project,clean-local,clean-workflow-local" description="Remove all build output" />

	<target name="init-user-properties">
		<property file="${user.home}/${ant.project.name}-build.properties" />
		<condition property="use.p6spy.local">
			<and>
				<equals arg1="${is.local.build}" arg2="true" />
				<equals arg1="${use.p6spy}" arg2="true" />
			</and>
		</condition>
		<echo message="Loaded properties in ${user.home}/${ant.project.name}-build.properties" />
	</target>

	<target name="init-project-properties" depends="init-user-properties">
		<property file="build.properties" />
		<condition property="load.institution.override.properties">
			<available file="${build.institution.overrides.file}" />
		</condition>
		<echo message="Loaded properties in ./build.properties and set dependent properties" />
	</target>
	
	<target name="init-logic-based-properties" depends="init-project-properties">
		<tstamp>
			<format property="project.cvs.tag" pattern="MM/dd/yyyy hh:mm aa" />
		</tstamp>
		<condition property="context.docbase" value=' docBase="${basedir}${file.separator}work${file.separator}web-root"'>
			<equals arg1="${is.local.build}" arg2="true" />
		</condition>
		<property name="context.docbase" value="" />
		<condition property="base.application.url" value="${local.environment.url}">
			<equals arg1="${is.local.build}" arg2="true" />
		</condition>
		<condition property="base.htdocs.url" value="${local.environment.url}">
			<equals arg1="${is.local.build}" arg2="true" />
		</condition>
		<condition property="base.cas.url" value="${local.environment.url}">
			<equals arg1="${is.local.build}" arg2="true" />
		</condition>
		<condition property="base.application.url" value="${prod.environment.url}">
			<or>
				<equals arg1="${build.environment}" arg2="ptd" />
				<equals arg1="${build.environment}" arg2="gl" />
			</or>
		</condition>
		<condition property="base.htdocs.url" value="${prod.environment.url}">
			<or>
				<equals arg1="${build.environment}" arg2="ptd" />
				<equals arg1="${build.environment}" arg2="gl" />
			</or>
		</condition>
		<condition property="base.cas.url" value="${prod.environment.url}">
			<or>
				<equals arg1="${build.environment}" arg2="ptd" />
				<equals arg1="${build.environment}" arg2="gl" />
			</or>
		</condition>
		<property name="base.application.url" value="${test.environment.url}" />
		<property name="base.htdocs.url" value="${test.environment.url}" />
		<property name="htdocs.url" value="${base.htdocs.url}${ant.project.name}/${build.environment}/" />
		<property name="base.cas.url" value="${test.environment.url}" />
		<property name="application.url" value="${base.application.url}${ant.project.name}-${build.environment}" />
		<property name="cas.url" value="${base.cas.url}${ant.project.name}-${build.environment}/cas" />
		<condition property="datasource.url" value="${mysql.datasource.url}">
			<equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" />
		</condition>
		<property name="datasource.url" value="${oracle.datasource.url}" />
		<condition property="driver.class" value="${p6spy.driver.class}">
			<equals arg1="${use.p6spy.local}" arg2="true"/>
		</condition>
		<condition property="driver.class" value="${mysql.driver.class}">
			<equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" />
		</condition>
		<property name="driver.class" value="${oracle.driver.class}" />
		<condition property="p6spy.real.driver.class" value="${mysql.driver.class}">
			<equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" />
		</condition>
		<property name="p6spy.real.driver.class" value="${oracle.driver.class}" />
		<condition property="ojb.sequencemanager.class" value="${mysql.sequence.manager.class}">
			<equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" />
		</condition>
		<property name="ojb.sequencemanager.class" value="${oracle.sequence.manager.class}" />
	    <condition property="database.platform.class" value="${mysql.database.platform}">
	    		<equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" />
	    </condition>
		<property name="database.platform.class" value="${oracle.database.platform}" />
	    <condition property="workflow.database.platform.class" value="${mysql.workflow.database.platform}">
	    		<equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" />
	    </condition>
		<property name="workflow.database.platform.class" value="${oracle.workflow.database.platform}" />
		<condition property="appenders" value="INFO, LogFile, StdOut">
			<equals arg1="${is.local.build}" arg2="true" />
		</condition>
		<property name="appenders" value="INFO, LogFile" />
		<!-- todo rice commons upgrade broke this -->
		<!--<condition property="startup.stats.mailing.list" value="${configuration.manager.mailing.list}">
			<equals arg1="${build.environment}" arg2="cnv" />
		</condition>-->
		<property name="startup.stats.mailing.list" value="" />
		<property name="use.quartz.scheduling" value="true" />
		<condition property="use.quartz.jdbc.jobstore" value="false">
			<equals arg1="${is.local.build}" arg2="true" />
		</condition>
		<property name="use.quartz.jdbc.jobstore" value="true" />
		<!-- todo this is hosed - need to figure out quartz solution or adapt p1 brte solution -->
		<condition property="database.file.directory" value="${batch.program.directory}/db">
			<equals arg1="${is.batch.dist}" arg2="true" />
		</condition>
		<path id="database.file.directory.temp" location="${basedir}/${database.directory}" />
		<pathconvert property="database.file.directory" targetos="unix" refid="database.file.directory.temp" />
	</target>

	<target name="init-institution-override-properties" if="load.institution.override.properties" depends="init-logic-based-properties">
		<property file="${build.institution.overrides.file}" />
		<echo message="Loaded properties in ${build.institution.overrides.file}" />
	</target>

	<target name="init-institution-default-properties" depends="init-institution-override-properties">
		<property file="${build.institution.defaults.file}" />
		<echo message="Loaded properties in ${build.institution.defaults.file}" />
		<condition property="test.spring.beans.import" value="${spring.test.imports}">
			<equals arg1="${import.test.spring.beans}" arg2="true" />
		</condition>
		<property name="test.spring.beans.import" value="" />
	</target>

	<target name="init-filter-sets" depends="init-institution-default-properties">
		<filterset id="general.filterset">
			<filter token="settings-root-directory" value="${settings.root.directory}" />
			<filter token="security-root-directory" value="${security.root.directory}" />			
			<filter token="log4j-settings-file" value="${settings.directory}/${log4j.settings.file}" />
			<filter token="security-directory" value="${security.directory}" />
			<filter token="settings-directory" value="${settings.directory}" />
			<filter token="logs-directory" value="${logs.directory}" />
			<filter token="staging-directory" value="${staging.directory}" />
			<filter token="attachments-directory" value="${attachments.directory}" />
			<filter token="reports-directory" value="${reports.directory}" />
			<filter token="workflow-xml-directory" value="${external.config.directory}/ears/${build.environment}/${workflow.application}/xml" />
			<filter token="workflow-web-authentication-filter" value="${workflow.web.authentication.filter}" />
			<filter token="application" value="${ant.project.name}" />
			<filter token="institution" value="${institution}" />
			<filter token="environment" value="${build.environment}" />
			<filter token="version" value="${project.cvs.tag}" />
			<filter token="application-url" value="${application.url}" />
			<filter token="htdocs-url" value="${htdocs.url}" />
			<filter token="htdocs-logs-url" value="${htdocs.url}logs/" />
			<filter token="htdocs-staging-url" value="${htdocs.url}staging/" />
			<filter token="cas-url" value="${cas.url}" />
			<filter token="workflow-url" value="${base.application.url}${ant.project.name}-${build.environment}/${workflow.application}" />
			<filter token="externalizable-static-content-url" value="${externalizable.static.content.url}" />
			<filter token="web-authentication-filter" value="${web.authentication.filter}" />
			<filter token="web-authentication-service" value="${web.authentication.service}" />
			<filter token="maintain-users-locally" value="${maintain.users.locally}" />
			<filter token="production-environment-code" value="${production.environment.code}" />
			<filter token="datasource-url" value="${datasource.url}" />
			<filter token="datasource-username" value="${datasource.username}" />
			<filter token="datasource-password" value="${datasource.password}" />
			<filter token="driver-class" value="${driver.class}" />
			<filter token="p6spy-real-driver-class" value="${p6spy.real.driver.class}" />
			<filter token="ojb-platform" value="${ojb.platform}" />
			<filter token="ojb-sequencemanager-class" value="${ojb.sequencemanager.class}" />
			<filter token="database-platform-class" value="${database.platform.class}" />
			<filter token="workflow-database-platform-class" value="${workflow.database.platform.class}" />
			<filter token="webservices-keystore-password" value="${webservices.keystore.password}" />
			<filter token="workflow-webservices-keystore-password" value="${workflow.webservices.keystore.password}" />
			<filter token="encryption-key" value="${encryption.key}" />
			<filter token="context-docbase" value="${context.docbase}" />
			<filter token="appenders" value="${appenders}" />
			<filter token="mail-relay-server" value="${mail.relay.server}" />
			<filter token="batch-mailing-list" value="${batch.mailing.list}" />
			<filter token="spring-imports" value="${spring.imports}" />
			<filter token="use-quartz-scheduling" value="${use.quartz.scheduling}" />
			<filter token="use-quartz-jdbc-jobstore" value="${use.quartz.jdbc.jobstore}" />
			<filter token="transaction-timeout" value="${transaction.timeout}"/>
			<filter token="startup-stats-mailing-list" value="${startup.stats.mailing.list}"/>
			<filter token="database-file-directory" value="${database.file.directory}" />
			<filter token="database-update-file-list" value="${database.update.file.list}" />
			<filter token="encrypt-attributes-properties-file" value="${encrypt.attributes.properties.file}" />
			<filter token="data-export-zip-file" value="${data.export.zip.file}" />
			<filter token="test-spring-beans-import" value="${test.spring.beans.import}" />
			<filter token="dev.mode" value="${dev.mode}" />
			<filter token="message.persistence" value="${message.persistence}" />
		</filterset>
	</target>
	
	<target name="init-make-references" depends="init-filter-sets">
		<path id="compile.source.classpath">
			<fileset dir="${appserver.lib.dir}" includes="*.jar" />
			<fileset dir="${lib.directory}" includes="*.jar" />
		</path>
		<path id="compile.tests.classpath">
			<path refid="compile.source.classpath" />
			<fileset dir="${test.lib.directory}" includes="*.jar" />
			<pathelement location="${build.workflow.appserver.directory}/classes"/>
			<fileset dir="${build.workflow.appserver.directory}" includes="*.jar"/>
		</path>
		<patternset id="non.java.resources">
			<include name="**/*.properties" />
			<include name="**/*.dtd" />
			<include name="**/*.xml" />
			<include name="**/*.html" />
			<include name="**/*.xsd" />
		</patternset>
	</target>

	<target name="init-source-only-package">
		<property name="package.type" value="source" />	
	</target>

	<target name="init-binary-only-package">
		<property name="package.type" value="binary" />
	</target>
	
	<target name="init-binary-and-source-package">
		<property name="package.type" value="both" />
	</target>
			
	<target name="init-package-directories" depends="init-project-properties">
		<delete dir="${packaging.contents.directory}" />
		<mkdir dir="${packaging.contents.directory}" />
		<get dest="${packaging.server.zip.file}" src="https://test.kuali.org/confluence/download/attachments/9969/${appserver}.zip" />
		<unzip src="${packaging.server.zip.file}" dest="${packaging.contents.directory}" />
	</target>

	<target name="clean-project" depends="init-project-properties">
		<delete dir="${metainf.directory}" />
		<delete file="${webinf.directory}/${web.xml.file}" />
		<delete failonerror="false">
			<fileset dir="${source.directory}" includes="${tokenized.source.files}" />
		</delete>
		<delete file="${lib.directory}/${log4j.library}" />
		<delete dir="${war.directory}" />
		<delete dir="${test.directory}" />
		<delete>
			<fileset dir="." includes="*.war" />
		</delete>
		<delete>
			<fileset dir="." includes="*.zip" />
		</delete>
	</target>

	<target name="clean-local" if="is.local.build" depends="init-project-properties">
		<delete failonerror="false">
			<fileset dir="${appserver.lib.dir}">
				<present targetdir="${build.appserver.directory}" />
			</fileset>
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.lib.dir}">
				<present targetdir="${drivers.directory}" />
			</fileset>
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.localhost.dir}" includes="${ant.project.name}-*.xml" />
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.deploy.dir}" includes="${ant.project.name}-*.war" />
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${appserver.work.dir}" includes="${ant.project.name}-*/**" />
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${appserver.deploy.dir}" includes="${ant.project.name}-*/**" />
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${settings.root.directory}" includes="*/${ant.project.name}/"/>
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${security.root.directory}" includes="*/${ant.project.name}/"/>
		</delete>
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${logs.root.directory}" includes="*/${ant.project.name}/"/>
		</delete>
		<delete dir="${static.root.directory}" failonerror="false" />
	</target>

	<target name="clean-workflow-local" if="is.local.build" depends="init-project-properties">
		<delete failonerror="false">
			<fileset dir="${appserver.classes.dir}" includes="${workflow.appserver.classes.list}" />
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.lib.dir}" includes="${workflow.appserver.library.list}" />
		</delete>
		<delete dir="${workflow.embedded.webapp.directory}" failonerror="false"/>
	</target>
	
	<target name="filter-project-log4j" unless="use.p6spy.local" depends="init-filter-sets">
		<copy file="${build.appserver.directory}/${log4j.library}" todir="${lib.directory}"/>
	</target>
	
	<target name="filter-project-p6spy" if="use.p6spy.local" depends="filter-project-log4j">
		<copy file="${build.appserver.directory}/${log4j.library}" todir="${appserver.lib.dir}"/>
	</target>
	
	<target name="filter-project" depends="filter-project-p6spy">
		<mkdir dir="${metainf.directory}" />
		<copy file="${build.tokenized.resources.directory}/${tomcat.context.file}" todir="${metainf.directory}" overwrite="true">
			<filterset refid="general.filterset" />
		</copy>
		<copy file="${build.tokenized.resources.directory}/${web.xml.file}" todir="${webinf.directory}" overwrite="true">
			<filterset refid="general.filterset" />
		</copy>
		<copy todir="${source.directory}" overwrite="true">
			<fileset dir="${build.tokenized.resources.directory}" includes="${tokenized.source.files}" />
			<filterset refid="general.filterset" />
		</copy>
	</target>

	<target name="filter-local" if="is.local.build" depends="init-filter-sets">
		<copy file="${build.appserver.directory}/${p6spy.library}" todir="${appserver.lib.dir}" overwrite="true" />
		<copy todir="${appserver.lib.dir}" overwrite="true">
			<fileset dir="${drivers.directory}" />
		</copy>
		<copy todir="${settings.directory}" overwrite="true">
			<fileset dir="${build.settings.directory}" />
			<filterset refid="general.filterset" />
		</copy>
		<copy file="${user.home}/${log4j.settings.file}" todir="${settings.directory}" failonerror="false" overwrite="true">
			<filterset refid="general.filterset" />
		</copy>
		<copy todir="${security.directory}" overwrite="true">
			<fileset dir="${build.security.directory}" excludes="${webservices.keystore.files}" />
			<filterset refid="general.filterset" />
		</copy>
		<copy todir="${security.directory}" overwrite="true">
			<fileset dir="${build.security.directory}" includes="${webservices.keystore.files}" />
		</copy>
		<copy todir="${logs.directory}" overwrite="true">
			<fileset dir="${build.logs.directory}" />
		</copy>
		<copy todir="${static.directory}" overwrite="true">
			<fileset dir="${build.static.directory}" />
			<filterset refid="general.filterset" />
		</copy>
	</target>
	
	<target name="filter-workflow-local" depends="init-filter-sets">
		<copy todir="${appserver.classes.dir}" overwrite="true">
			<fileset dir="${build.workflow.appserver.directory}" includes="${workflow.appserver.classes.list}" />
		</copy>
		<copy todir="${appserver.lib.dir}" overwrite="true">
			<fileset dir="${build.workflow.appserver.directory}" includes="${workflow.appserver.library.list}" />
		</copy>
	</target>

	<target name="make-source" depends="init-make-references,filter-project">
		<mkdir dir="${make-source.target.directory}" />
		<javac destdir="${make-source.target.directory}" srcdir="${source.directory}" debug="true" deprecation="true" optimize="true" fork="true" memoryinitialsize="${compile.min.memory}" memorymaximumsize="${compile.max.memory}">
			<classpath refid="compile.source.classpath" />
		</javac>
		<copy todir="${make-source.target.directory}">
			<fileset dir="${source.directory}">
				<patternset refid="non.java.resources" />
			</fileset>
		</copy>
	</target>

	<target name="use-test-spring-beans">
		<property name="import.test.spring.beans" value="true" />
		<!-- force scheduler on -->
		<property name="use.quartz.scheduling" value="true" />
	</target>

	<target name="make-tests" depends="use-test-spring-beans,init-make-references,filter-project">
		<mkdir dir="${test.classes.directory}" />
		<javac destdir="${test.classes.directory}" debug="true" deprecation="true" optimize="true" fork="true" memoryinitialsize="${compile.min.memory}" memorymaximumsize="${compile.max.memory}">
			<classpath refid="compile.tests.classpath" />
			<src path="${source.directory}" />
			<src path="${test.source.directory}" />
		</javac>
		<copy todir="${test.classes.directory}">
			<fileset dir="${test.source.directory}">
				<patternset refid="non.java.resources" />
				<include name="**/*.txt" />
			</fileset>  
		</copy>
		<copy todir="${test.classes.directory}">
			<fileset dir="${source.directory}">
				<patternset refid="non.java.resources" />
			</fileset>
		</copy>
	</target>
	
	<target name="make-zips" depends="filter-local,filter-workflow-local">
		<zip destfile="settings.zip" basedir="${settings.directory}" />
		<zip destfile="security.zip" basedir="${security.directory}" />
		<zip destfile="skel.zip" basedir="${static.directory}" />
	</target>
	
	<target name="make-source-only-package" depends="init-package-directories">
		<copy todir="${packaging.distribution.directory}" includeemptydirs="false">
			<fileset dir="${basedir}" excludes="**/*.class,${packaged.build.properties.files}" />
		</copy>
	</target>
	
	<target name="make-javadoc" depends="init-project-properties">
		<mkdir dir="${packaging.javadoc.directory}"/>
	    <javadoc destdir="${packaging.javadoc.directory}" packagenames="org.*" locale="en" useexternalfile="yes" maxmemory="512M">
	        <sourcepath>
	        		<pathelement location="${source.directory}"/>
	        </sourcepath>
	    		<classpath refid="compile.source.classpath"/>
	    </javadoc>
	</target>

	<target name="make-binary-only-package" depends="init-package-directories,dist,make-javadoc">
		<copy file="${ant.project.name}-${build.environment}.war" todir="${build.appserver.directory}" />
		<ant target="clean-project" />
		<copy todir="${packaging.distribution.directory}" includeemptydirs="false">
			<fileset dir="${basedir}" includes="*.*,licenses/**/*,build/**/*" excludes="${packaged.build.properties.files}" />
		</copy>
	</target>
	
	<target name="make-binary-and-source-package" depends="make-source-only-package,make-binary-only-package" />
	
	<!-- please be careful if you muck with these settings - you can seriously hose the continuous integration process -->
	<target name="test">
		<mkdir dir="${test.temp.directory}" />
		<mkdir dir="${test.xml.results.directory}" />
		<junit showoutput="true" fork="true" forkmode="once" failureproperty="tests.failed" errorproperty="tests.errored" tempdir="${test.temp.directory}" maxmemory="512M">
			<jvmarg value="-Dorg.kuali.test.KualiTestBase.skipOpenOrInProgressOrReopenedJiraIssues"/> 
			<classpath>
				<path refid="compile.tests.classpath" />
				<pathelement location="${test.classes.directory}" />
			</classpath>
			<formatter type="xml" />
			<batchtest todir="${test.xml.results.directory}">
				<fileset dir="${test.source.directory}"> 
					<include name="${tests.includes}" />	
					<exclude name="**/TransactionalDocumentRuleTest.java" />
					<exclude name="**/${test.spring.shutdown}.java" />
				</fileset>
			</batchtest>
			<test name="org.kuali.${test.spring.shutdown}" todir="${test.xml.results.directory}" />
		</junit>
		<mkdir dir="${test.html.results.directory}" />
		<junitreport todir="${test.html.results.directory}">
			<fileset dir="${test.xml.results.directory}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${test.html.results.directory}" />
		</junitreport>
		<echo message="Generated test results: ${test.html.results.directory}/index.html" />
	</target>
	
	<target name="dist" depends="make-source">
		<unzip dest="${war.directory}" src="${build.workflow.appserver.directory}/workflow-embedded-content.zip"/>
		<copy todir="${war.directory}">
			<fileset dir="${webroot.directory}" excludes="WEB-INF/classes/**/**" />
		</copy>
		<jar jarfile="${ant.project.name}-${build.environment}.war" basedir="${war.directory}" compress="false" />
	</target>

	<target name="dist-workflow-local" depends="filter-workflow-local">
		<unzip dest="${webroot.directory}" src="${build.workflow.appserver.directory}/workflow-embedded-content.zip"/>
	</target>

	<target name="dist-package" depends="init-package-directories">
		<copy todir="${packaging.distribution.directory}">
			<fileset dir="${basedir}" includes="${packaged.build.properties.files}" />
			<filterset>
				<filter token="package-type" value="${package.type}" />
				<filter token="classes-directory" value="${classes.directory}" />
			</filterset>
		</copy>
		<delete file="${packaging.contents.directory}-${package.type}.zip" />
		<zip basedir="${packaging.contents.directory}" destfile="${packaging.contents.directory}-${package.type}.zip" />
	</target>

	<target name="dist-source-only-package" depends="init-source-only-package,make-source-only-package,dist-package"/>
		
	<target name="dist-binary-only-package" depends="init-binary-only-package,make-binary-only-package,dist-package"/>
	
	<target name="dist-binary-and-source-package" depends="init-binary-and-source-package,make-binary-and-source-package,dist-package" />
		
	<target name="continuous-integration" depends="use-test-spring-beans,clean,make-tests,test">
		<fail if="tests.failed" message="Tests failed" />
	</target>

	<target name="update-workflow" depends="init-project-properties">
		<property name="${workflow.application}.workflow.environment" value="${build.environment}" />
		<property name="${workflow.application}.tomcat5.home" value="${appserver.home}" />
		<property name="${workflow.application}.institution" value="${ant.project.name}" />
		<property name="${workflow.application}.src.dist.loc" value="${workflow.project.directory}/dist" />
		<property name="${workflow.application}.datasource.ojb.platform" value="${ojb.platform}" />
		<propertyset id="en-properties">
		  <propertyref prefix="${workflow.application}."/>
		  <mapper type="glob" from="${workflow.application}.*" to="*"/>
		</propertyset>
		<ant dir="${workflow.project.directory}" target="clean" inheritall="false"/>
		<ant dir="${workflow.project.directory}" target="dist-embedded-web-content" inheritall="false">
			<propertyset refid="en-properties" />
		</ant>
		<copy file="${workflow.project.directory}/dist/workflow-embedded-content.zip" todir="${build.workflow.appserver.directory}" overwrite="true" />
		<ant dir="${workflow.project.directory}" target="dist-client-not-iu" inheritall="false">
			<propertyset refid="${workflow.application}-properties" />
		</ant>
		<copy file="${workflow.project.directory}/dist/workflow-client-${workflow.version}.jar" todir="${lib.directory}" overwrite="true" />
		<copy todir="${licenses.directory}/kew">
			<fileset dir="${workflow.project.directory}/${licenses.directory}" />
		</copy>
		<delete dir="${database.workflow.directory}" failonerror="false" />
		<copy todir="${database.workflow.directory}">
			<fileset dir="${workflow.project.directory}/${workflow.ddl.directory}" includes="**/**" />
		</copy>
	</target>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: maven          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="maven">
        <attribute name="goals" />
        <attribute name="project" default="rice" />
        <attribute name="offline" default="true" />
        <attribute name="mavenHome" />
        <sequential>
        	<condition property="maven.options" value="--offline">
        		<equals arg1="@{offline}" arg2="true" casesensitive="false" trim="true"/>
        	</condition >
            <java classname="org.codehaus.classworlds.Launcher" dir="${@{project}.project.directory}" fork="true" >
            	<arg line="${maven.options} @{goals}"/>
            	<sysproperty key="classworlds.conf" value="@{mavenHome}/bin/m2.conf"/>
            	<sysproperty key="maven.home" value="@{mavenHome}"/>
            	<sysproperty key="maven.test.skip" value="true"/>
            	<classpath>
            		<fileset dir="@{mavenHome}/boot">
    					<include name="classworlds-*.jar"/>
					</fileset>
            	</classpath>
            </java>
        </sequential>
    </macrodef>

	<target name="update-rice-jar" depends="init-project-properties">
		<!-- build the rice jar and war files -->
		<maven goals="package" mavenhome="${maven.home.directory}" />
		<!-- copy main JAR file to lib directory -->
		<copy file="${rice.project.directory}/kns/target/kns-${rice.version}.jar" todir="${lib.directory}" overwrite="true" />
	</target>

	<target name="update-rice-web" depends="init-project-properties">
		<!-- copy the central web content from rice into KFS -->
		<delete>
			<fileset dir="${work.directory}/web-root/kr">
				<include name="**/*.*" />
			</fileset>
		</delete>
		<delete>
			<fileset dir="${work.directory}/web-root/WEB-INF/tags/kr">
				<include name="**/*.tag" />
			</fileset>
		</delete>
		<unzip src="${rice.project.directory}/sampleapp/target/sampleapp-${rice.version}.war" dest="${work.directory}/web-root" overwrite="true">
		    <patternset>
		    	<include name="kr/**/**" />		    	
		    	<include name="WEB-INF/tags/kr/**/*.tag" />
		    </patternset>
		</unzip>
	</target>
	
	<target name="update-rice-misc" depends="init-project-properties">
		<!-- copy licenses -->
		<!--
		<copy todir="${licenses.directory}/rice">
			<fileset dir="${rice.project.directory}/${licenses.directory}" />
		</copy>
		-->
		<!-- copy DDL files -->
		<delete dir="${database.rice.directory}" failonerror="false" />
		<copy todir="${database.rice.directory}">
			<fileset dir="${rice.project.directory}/${rice.ddl.directory}" includes="**/**" />
		</copy>
	</target>

	<target name="update-rice-javadoc" depends="init-project-properties">
		<!-- generate the javadoc and copy to kuali-dependencies -->
		<maven goals="javadoc:jar" mavenhome="${maven.home.directory}" />
		<copy todir="${dependencies.project.directory}" file="${rice.project.directory}/kns/target/kns-${rice.version}-javadoc.jar" overwrite="true" />
	</target>

	<target name="update-rice-src" depends="init-project-properties">
		<!-- TODO: jar the source and place in kuali_dependencies -->
		<jar destfile="${dependencies.project.directory}/kns-${rice.version}-src.jar">
			<fileset dir="${rice.project.directory}/kns/src/main/java">
				<include name="**/**"/>
			</fileset>
		</jar>
	</target>

	<target name="update-rice" depends="init-project-properties,update-rice-jar,update-rice-web,update-rice-misc" />		
	
	<target name="help" description="Describe public targets">
		<echo>--- OVERVIEW ---
			 
	the following configuration files are involved in the build process
			- build.xml
			- build.properties
			- build/*
			- ${user.home}\${ant.project.name}-build.properties
			
	you should start using this build script as follows
			- copy build/configurationFiles/userHomeDirectory/${ant.project.name}-build.properties to ${user.home}
			- obtain the values for ${datasource.username}, ${datasource.password}, ${webservices.keystore.password}
			  and ${encryption.key} for the dev environment from someone on the project, and put them in
			  ${user.home}\${ant.project.name}-build.properties
			- override other property values in ${user.home}\${ant.project.name}-build.properties to permanently
			  customize the build process for your machine or temporarily customize the process for execution of a
			  given build target
			- follow the instructions associated with the dist-local target and run that target
			- run the echo-properties target and review the results
			- click the "Run/Stop/Restart MyEclipse Application Servers" button in the "Java (default)" perspective in
			eclipse to start tomcat
			- launch a browser and access http://localhost:8080/kuali-dev
			
	you can override the default log4j settings for your local deployments by copying 
		build/configurationFiles/externalConfigDirectory/settings/${log4j.settings.file} to
			${user.home}/${log4j.settings.file} and modifying as desired.  you will also need to run the dist-local target
			for this change to take effect.
			
			if you would like to suggest a configuration change, enter a Jira issue in the KULCFG project with the details
			
			--- TARGETS ---

			dist-local: prepares tokenized resources and local configuration files and deploys tomcat context file on development workstation
			- this target should be run each time you update the project, change property values in ${user.home}\${ant.project.name}-build.properties,
			or make a change that you want to apply to the application workflow plugin
			- tomcat should not be running when you are executing this target
			
			test-local: runs all project tests and generates results
             - criteria for running dist-local must be met before running this target
			- you can customize the set of tests that run by modifying the value of tests.includes in ${user.home}\${ant.project.name}-build.propertie
			- tomcat should not be running when you execute this target
			
			echo-properties: executes ant echoproperties task, thereby printing out all the properties that have been set
			
			clean: removes all build output
		</echo>
	</target>
</project>